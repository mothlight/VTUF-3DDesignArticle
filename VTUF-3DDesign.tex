%% 
%% Copyright 2007, 2008, 2009 Elsevier Ltd
%% 
%% This file is part of the 'Elsarticle Bundle'.
%% ---------------------------------------------
%% 
%% It may be distributed under the conditions of the LaTeX Project Public
%% License, either version 1.2 of this license or (at your option) any
%% later version.  The latest version of this license is in
%%    http://www.latex-project.org/lppl.txt
%% and version 1.2 or later is part of all distributions of LaTeX
%% version 1999/12/01 or later.
%% 
%% The list of all files belonging to the 'Elsarticle Bundle' is
%% given in the file `manifest.txt'.
%% 
%% Template article for Elsevier's document class `elsarticle'
%% with harvard style bibliographic references
%% SP 2008/03/01

%\documentclass[preprint,12pt,authoryear]{elsarticle}  %default in the template
%\documentclass[preprint,10pt,authoryear]{elsarticle}

%% Use the option review to obtain double line spacing
%% \documentclass[authoryear,preprint,review,12pt]{elsarticle}

%% Use the options 1p,twocolumn; 3p; 3p,twocolumn; 5p; or 5p,twocolumn
%% for a journal layout:
%% \documentclass[final,1p,times,authoryear]{elsarticle}
%% \documentclass[final,1p,times,twocolumn,authoryear]{elsarticle}
 \documentclass[final,3p,times,authoryear]{elsarticle}
%% \documentclass[final,3p,times,twocolumn,authoryear]{elsarticle}
%% \documentclass[final,5p,times,authoryear]{elsarticle}
%% \documentclass[final,5p,times,twocolumn,authoryear]{elsarticle}

%% For including figures, graphicx.sty has been loaded in
%% elsarticle.cls. If you prefer to use the old commands
%% please give \usepackage{epsfig}

%% The amssymb package provides various useful mathematical symbols
\usepackage{amssymb}
%% The amsthm package provides extended theorem environments
 \usepackage{amsthm}
 \usepackage{amsmath}
 \usepackage{color}
 \usepackage{amsmath}
\usepackage{siunitx}


\usepackage{framed} % Framing content
\usepackage{multicol} % Multiple columns environment
\usepackage{nomencl} % Nomenclature package
\makenomenclature
%\setlength{\nomitemsep}{-\parskip} % Baseline skip between items
\setlength{\nomitemsep}{0.01cm}
\renewcommand*\nompreamble{\begin{multicols}{2}}
\renewcommand*\nompostamble{\end{multicols}}



%% The lineno packages adds line numbers. Start line numbering with
%% \begin{linenumbers}, end it with \end{linenumbers}. Or switch it on
%% for the whole article with \linenumbers.
%% \usepackage{lineno}

\journal{Urban Climate}

\begin{document}

\begin{frontmatter}

%% Title, authors and addresses

%% use the tnoteref command within \title for footnotes;
%% use the tnotetext command for theassociated footnote;
%% use the fnref command within \author or \address for footnotes;
%% use the fntext command for theassociated footnote;
%% use the corref command within \author for corresponding author footnotes;
%% use the cortext command for theassociated footnote;
%% use the ead command for the email address,
%% and the form \ead[url] for the home page:
%% \title{Title\tnoteref{label1}}
%% \tnotetext[label1]{}
%% \author{Name\corref{cor1}\fnref{label2}}
%% \ead{email address}
%% \ead[url]{home page}
%% \fntext[label2]{}
%% \cortext[cor1]{}
%% \address{Address\fnref{label3}}
%% \fntext[label3]{}

\title{Creation of the VTUF-3D v1.0 urban micro-climate model to support assessments of urban vegetation influences on HTC at a micro-scale in urban canyons}


%% use optional labels to link authors explicitly to addresses:
\author[monash,crc]{Kerry~Nice\corref{cor1}}
\ead{mothlight@fastmail.fm}
\author[monash,crc]{Andrew Coutts}
\author[monash,crc]{Nigel~Tapper}
\cortext[cor1]{Principal corresponding author}
\address[monash]{School of Earth, Atmosphere and Environment, Monash University, Australia}
\address[crc]{CRC for Water Sensitive Cities, Australia}


\begin{abstract}

With urban areas facing future longer duration heat-waves and temperature extremes from climate change and growing urban development, adaptation strategies are needed. Examining the role that increased tree cover and water availability can have on human thermal comfort (HTC) in urban areas requires a modelling tool suited for this task. This model must provide sufficient resolution to resolve urban influences on HTC and the ability to model the physiological processes of vegetation. The lack of such a model has been identified as a research gap in the urban climate area and has impaired the ability to fully examine the use of urban greenery and water for improved human thermal comfort. 

A new model, VTUF-3D (Vegetated Temperatures Of Urban Facets), addresses this gap by embedding the functionality of the MAESPA tree process model \citep{Duursma2012}, that can model individual trees, vegetation, and soil components, within the TUF-3D \citep{Krayenhoff2007} urban micro-climate model. An innovative tiling approach, allows the new model to account for important vegetative physiological processes and shading effects using configurable templates to allow representation of any type of vegetation or water sensitive design feature. The high resolution of VTUF-3D is sufficient to examine the processes that drive human thermal comfort (HTC). This allows detailed calculations of surface temperatures, mean radiant temperature ($T_{mrt}$), and a HTC index, the universal thermal climate index (UTCI), across an urban canyon. 

\nomenclature{$T_{mrt}$}{mean radiant temperature (\SI{}{\degreeCelsius})}  
\nomenclature{$UTCI$}{universal thermal climate index}

An extensive validation process, using three different observation data sets to validate a number of different and key aspects of the VTUF-3D model, has shown it performs well and is suitable for use to examine critical questions relating to the role of vegetation and water in the urban environment. Using this model, it is now possible to conduct further analysis to quantify the impact each individual tree can have on temperatures in urban canyons. Further, the model can help inform the optimal arrangement and quantity of trees to maximise temperature moderation effects and be used to generate best practices guidelines for urban greening.
\end{abstract}

\begin{keyword}
micro-climate modelling urban vegetation
%% keywords here, in the form: keyword \sep keyword

%% PACS codes here, in the form: \PACS code \sep code

%% MSC codes here, in the form: \MSC code \sep code
%% or \MSC[2008] code \sep code (2000 is the default)

\end{keyword}

\end{frontmatter}

\begin{table*}[!t]   
\begin{framed}
\printnomenclature
%\input{VTUF-3DDesign_Nomenclature}
\end{framed}
\end{table*}



%% \linenumbers

%% main text

\section{Introduction}\label{sec:introduction}
Urban areas are facing a growing number of problems. Populations of urban areas, holding the majority of the world's population \citep{UNDESA2015,WHO2016}, are becoming denser while demographics are shifting towards increased older and elderly citizens \citep{ABS2008}. There are rapid conversions of green spaces into urban areas \citep{DSE2002,Coutts2007}. Climate trends are towards increased average temperatures and increasing temperature extremes \citep{Alexander2009,IPCC2013a}. At the same time, there is an increasing understanding of impacts to human health of extreme temperatures \citep{Katsouyanni1993,Nicholls2008,Loughnan2010}. These factors leave those in urban areas in an increasingly dangerous position. In coming years, strategies are needed to adapt to and deal with these challenges.

Incorporating water sensitive urban design (WSUD) and urban greening principles into urban areas can be an effective way to deal with many of these problems. From an examination of a range of different studies exploring cooling effects of urban greenery \citep{Tsiros2010,Shashua-Bar2000,Shashua-Bar2010a,Spangenberg2008}, it is clear that increased vegetation and water can have an impact, from city-wide scale down to a micro-climate street level scale \citep{Coutts2012}. Shading and evapotranspiration are cited \citep{Bowler2010} as the main drivers of these cooling effects. Also cited are factors of vegetation density, orientation, and amounts of irrigation used. 

WSUD is premised on the use of captured and retained stormwater as an additional urban water source \citep{Wong2009}. It uses engineered and natural features (trees and vegetation) to capture, filter, and store water, while restoring a more natural water balance distorted by impervious surfaces and other modifications to previously natural landscapes. A more focused effort in using WSUD and WSUD features (especially the vegetated components) for urban climate benefits can deliver improvements to human thermal comfort (HTC). An extension to WSUD, Climate Sensitive Urban Design (CSUD) proposes exactly to do this \citep{Coutts2012}. The three mechanisms cited to provide these benefits are oasis effects (cooling through evapotranspiration), the use of WSUD augmented water supplies to promote healthy vegetation, which provides shading and transpiration cooling effects, and finally the reduction of surface temperatures. However, with only a small body of work in this area, \cite{Coutts2012} cites the need for additional research to fully explore these possibilities. 

A suitable modelling tool is needed, as guidance on how to most effectively use WSUD for HTC benefits is lacking. More importantly, there is a lack of solid quantitative assessments of how well WSUD and CSUD can perform in urban areas in terms of heat mitigation. A review shows there are a number of models available and techniques suitable to model urban areas, and to a lesser extent, to include vegetation as part of this assessment \citep{Nice2016}. A suitable modelling tool for these assessments needs to resolve detailed temperature gradients (as well as wind speed and humidity in order to calculate HTC) across a modelled urban canyon. This necessitates micro-scaled resolution. In addition, proper modelling of latent energy fluxes and vegetation is critical to WSUD studies, as a desired side effect of WSUD is localised cooling effects due to increased water and vegetation within the urban canyon. However, no existing models meet this requirement. Models such as SOLWEIG \citep{SOLWEIG2011} and RayMan \citep{Matzarakis2007,Matzarakis2010} resolve at a suitable scale and generate useful insights into urban areas \citep{Chen2014a}, however they only capture the radiation shading effects of vegetation, and are unable to account for the effects of water and evaportranspiration. At the other end of the complexity spectrum, a number of models, primarily based on computational fluid dynamics (CFD), are able to resolve at a micro-scale and account for many of the influences of vegetation \citep{Bailey2014,Bailey2016,Kunz2000,Schlunzen2011a,Yamada2011,Bruse1999}. However their complexity and computational intensity leaves them out of reach for less specialised users.

What is needed is an approach that fits in between these two levels of complexity, a new innovative method to balance detail, accuracy, and complexity with efficiency and usability, while also being able to consider a wide variety of vegetation types and arrangements. This approach needs to capture the detailed movement of radiation through complex urban areas integrated with a widely configurable amount of vegetation. It also needs to balance this complexity against usability to create a model that can be widely used to consider a large variety of questions about HTC impacts of urban vegetation in support of urban planning decisions and guidelines. 

The TUF-3D (Temperatures Of Urban Facets in 3D) model \citep{Krayenhoff2007} has been identified as a starting point for a new model that will address these problems, however its lack of vegetation and water modelling leaves it incomplete. Coupling TUF-3D with the MAESPA model \citep{Duursma2012}, allowing insertion of any type of vegetation in any arrangement, accounting for vegetation structural and physiological processes and including their influences, can create the model needed for assessing WSUD features in support of HTC in urban areas.

Now, with the completion of this new model, VTUF-3D (Vegetated Temperatures Of Urban Facets) v1.0, it can be used to start assessing the impacts of WSUD. This can facilitate the integration of urban greening into the urban landscapes and inform planning decisions with urban climate knowledge about how to best utilise urban greening to maximise the thermal comfort impacts and meet the challenges of urban heat. The cooling benefits of urban vegetation, through shading effects and evapotranspiration, can be examined for their micro-climate benefits, filling a large research gap on how to best protect human health in light of all the concerning trends progressing in urban areas.

\section{Methodology}\label{sec:method}

\subsection{Overview of changes}\label{sec:DesignOverview}

To model the impacts of increased water and vegetation on human thermal comfort in urban areas requires modifications to the TUF-3D \citep{Krayenhoff2007} model. TUF-3D in its unmodified form lacks functionality for the physical representation of vegetation along with their physiological processes. Also missing are latent energy fluxes and the water cycle associated with soil, vegetation, evaporation, and precipitation. 

Two major changes must be made to the TUF-3D model to add this missing functionality. The first is representation of vegetation's physical form and radiative interactions within an urban canyon. VTUF-3D (Vegetated Temperatures Of Urban Facets) uses cube shaped structures (as TUF-3D uses to represent buildings) to represent vegetation. These cubes store the surface properties and states and interact with the rest of the VTUF-3D domain. The vegetation's true shape is represented in MAESPA \citep{Duursma2012}, with each vegetation element individually modelled offline, calculating values of vegetation absorption, transmission, and reflection to be loaded by VTUF-3D as needed in a simulation (Figure \ref{fig:TUFWithMaespaVegRadiation}).  

\begin{figure}[!htbp]
 \includegraphics[trim = 15mm 41mm 0mm 31mm, clip, scale=0.45]{images/TUFWithMaespaVegRadiation.pdf}  
 \caption{Integration of MAESPA tree model into VTUF-3D radiation fluxes routines, in which tiled instances of MAESPA vegetation (in green) are used to calculate radiation transmission for VTUF-3D placeholder vegetation structures (in grey)\label{fig:TUFWithMaespaVegRadiation}.}
\end{figure}

The second major change required is including the physiological processes of vegetation and soil in the model. Using a novel approach, MAESPA tiles replace VTUF-3D ground surfaces with vegetated MAESPA surfaces and use results of MAESPA's photosynthesis and water cycle routines to modify VTUF-3D's energy balance calculations. Each embedded MAESPA surface calculates a full 3 dimensional tree (along with associated soil and movement of water) and feeds results back to VTUF-3D ground surface energy balances (Figure \ref{fig:TUFWithMaespaInsert}). 

\begin{figure}[!htbp]
 \includegraphics[trim = 0mm 14mm 22mm 0.0mm, clip, scale=0.25]{images/TUFWithMaespaInsert.png}
 \caption{VTUF-3D energy balance modelling with vegetation MAESPA tiles\label{fig:TUFWithMaespaInsert}.}
\end{figure}

At the conclusion of each timestep, VUF-3D calculates the energy balance of each surface. Incoming radiation energy and existing stored energy are partitioned into new values of stored and radiated heat. A variable for latent energy has been added to the  model and energy is allocated to it from the pool of available energy. The vegetation is treated as a flat two dimensional ground surface tile for the surface energy balances. Tiles of MAESPA instances (in each an individual tree or other types of vegetation) are used for surfaces that have vegetation (Figure \ref{fig:TUFWithMaespaInsert}). These instances provide values of radiation transmission, energy fluxes, and soil water storage for each item of vegetation in the domain using their unique properties and characteristics. If a surface does not contain vegetation, VTUF-3D runs its normal energy balance calculations. 

\subsection{Model description}
In the following sections, the VTUF-3D model is detailed. This model is constructed using the TUF-3D model, as described in \cite{Krayenhoff2007}, leaving all its components largely unchanged except for the two interactions as described in the overview of changes (Section \ref{sec:DesignOverview}). The vegetation functionality is added through the MAESPA model, described in \cite{Duursma2012}, with some of its components running in parallel and replacing some of the TUF-3D components in some parts of a modelled domain. The linkage components will be described later in this article in the model integration section, Section \ref{sec:integration}.

\subsection{Radiative processes}
\subsubsection{Radiative transfer}\label{sec:radiativetransfer}

In order to track the movement and allocation of radiation, VTUF-3D's modelling domain is built up in 3-D using cubes and their surfaces (facets). Ray tracing determines the visibility of each surface to each other, matched using plane parallel analytical equations of \cite{Siegel2001} and \cite{Hottel1967}. Ray tracing also determines determine sunlit and shaded patterns on the 3-D urban surface throughout a simulation using a modified version of the \cite{Soux2004} algorithm. Reflections and absorption of longwave and shortwave are modelled using a radiosity approach (radiative reflection and emission treated as perfectly diffuse). All the specific details of these radiative transfer calculations are contained in \cite{Krayenhoff2007}.

For vegetated parts of the domain, radiative transfer is calculated by components from MAESPA. Incoming radiation, both photosynthetic radiation (PAR) and near infrared (NIR) is partitioned into direct and diffuse using \cite{Weiss1985}. Canopy structure is calculated based on \cite{Wang1990}, supporting a variety of crown shapes including conical, half-ellipsoidal, and paraboloidal. Absorption and scattering of radiation (PAR, NIR, and thermal radiation) by the canopy is calculated using \cite{Norman1979}. Full details of all calculations are included in \cite{Duursma2012}.

\subsubsection{Stomatal conductance}\label{Stomatalconductance}
Stomatal conductance within the vegetation uses MAESPA components based on the widely used Ball-Berry type approach \citep{Ball1987,Duursma2012}. Options are available to use a number of variations including: the Ball-Berry model \citep{Ball1987}, the Ball-Berry-Leuning model \citep{Leuning1995}, the Ball-Berry-Opti model \citep{Medlyn2011}, the Tuzet model \citep{Tuzet2003}. The use of this stomatal conductance approach requires more detailed parameters than the `Big Leaf' stomatal resistance scheme \citep{Bailey1981,Kowalczyk1991}, but this detail allows modelling of specific species as well as variations of canopy size and vegetation health and drilling down to specific items of vegetation \citep{Duursma2012} as opposed to a canopy-wide average. 

\subsubsection{Calculation of leaf temperature and leaf water potential}\label{sec:calcleaftemp}
Solving the Tuzet variation of the Ball-Berry stomatal conductance, using $E_{L}$, leaf level transpiration rate ($\mu$mol m$^{-2}$s$^{-1}$), to find $\Psi_{L}$, the leaf water potential ($MPa$), is used to estimate leaf temperature throughout the canopy. For each grid point, $E_{L}$ is calculated with the Penman-Monteith equation, using the boundary layer conductance and total conductance (all detailed in the next section, Section \ref{sec:totalcanopy}). Leaf temperature is found by iteratively closing the energy balance of the leaf, based on \cite{Wang1998}. See \cite{Duursma2012} for complete details.

%\nomenclature{$E_{L}$}{leaf level transpiration rate ($\mu$mol m$^{-2}$s$^{-1}$)} 
%\nomenclature{$\Psi_{L}$}{leaf water potential (MPa)} 

\subsubsection{Total canopy transpiration}\label{sec:totalcanopy}

Canopy transpiration is calculated using the Penman-Monteith equation \citep{Penman1948,Monteith1965}. It is calculated by summing the application of the equation to each grid point using the calculated amounts of absorbed radiation (PAR, NIR, and thermal) for each tree. $g_{B}$, boundary layer conductance (mol m$^{-2}$s$^{-1}$), and $g_{V}$, the total conductance to water vapour (mol m$^{-2}$s$^{-1}$), are calculated using \cite{Jones1992}. The output of the canopy transpiration is used in Section \ref{sec:calcleaftemp} for leaf temperature calculations. See \cite{Duursma2012} for complete details.

%\nomenclature{$g_{B}$}{boundary layer conductance (mol m$^{-2}$s$^{-1}$)} 
%\nomenclature{$g_{V}$}{total conductance to water vapour (mol m$^{-2}$s$^{-1}$)} 


\subsubsection{Conduction and surface temperatures}

Heat conduction between the layers in each surface in VTUF-3D (based on TUF-3D) is calculated in a 1-D equation, based on \cite{Masson2000}. Calculating the surface temperature (the boundary condition for the surface) using the energy balance of the surface is based on a version of \cite{Arnfield1990}. See \cite{Krayenhoff2007} for complete details.


\subsubsection{Energy balance partitioning during simulation timesteps}\label{sec:parttimestep}
\nomenclature{$T_{sfc}$}{surface temperature (K)} 
\nomenclature{$Q^{*}_{veg}$}{calculation of vegetation net radiation flux density (Wm$^{-2}$)}
\nomenclature{$Q^{*}$}{net radiation flux density (Wm$^{-2}$)} 

As the simulation proceeds through each time step, an energy balance is performed on each surface. For each surface with vegetation, the surface temperature ($T_{sfc}$) is set to the value calculated by MAESPA for that tree. The following describe the differences from the normal calculations the unmodified TUF-3D uses to calculate the energy balances needed by VTUF-3D to partition the energy fluxes of a vegetated surface.

Net radiation, is calculated in Equation (\ref{eq:rnet}) ($Q^{*}_{veg}$ for vegetated grid squares, otherwise $Q^{*}$), 


\begin{equation}\label{eq:rnet}
\begin{split}
Q^{*}_{veg} =& K\downarrow - (\alpha _{veg} K\downarrow) + \epsilon _{veg} L\downarrow - \epsilon _{veg} \sigma  (T_{sfc,veg}) ^{4} 
\\
Q^{*} =& K\downarrow - (\alpha K\downarrow) + \epsilon L\downarrow - \epsilon \sigma  (T_{sfc}) ^{4} 
\end{split}
\end{equation}

where $K\downarrow$ is the downward shortwave radiative flux density (Wm$^{-2}$), $L\downarrow$ is the downward longwave radiative flux density (Wm$^{-2}$), $\alpha _{veg}$ of vegetation is set to 0.20 and $\epsilon _{veg}$ of vegetation set to 0.97 \citep[p. 12]{Oke1987z}, otherwise $\alpha$ and $\epsilon$ are set to user configured values (model default values are 0.10 and 0.92 \citep{Krayenhoff2007}), and $\sigma$ is the Stefan-Boltzmann constant (=5.67 $\times$ 10$^{-8}$Wm$^{-2}$K$^{-4}$), and $T_{sfc,veg}$ is the vegetation surface temperature (K), or $T_{sfc}$ for non-vegetated surfaces.

\nomenclature{$K\downarrow$}{downward shortwave radiative flux density (Wm$^{-2}$)} 
\nomenclature{$L\downarrow$}{downward longwave radiative flux density (Wm$^{-2}$)}
\nomenclature{$\alpha _{veg}$}{shortwave albedo of vegetation}
\nomenclature{$\epsilon _{veg}$}{longwave emissivity of vegetation}
\nomenclature{$\alpha$}{shortwave albedo }
%\nomenclature{$\sigma$}{Stefan-Boltzmann constant (=5.67 $\times$ 10$^{-8}$Wm$^{-2}$K$^{-4}$)} 
\nomenclature{$T_{sfc,veg}$}{vegetation surface temperature (K)} 

For sensible heat fluxes ($Q_{H}$), vegetation is accounted for differently by using the $T_{sfc}$ of the vegetation instead of the TUF-3D $T_{sfc}$ value in Equation (\ref{eq:qhveg}) and will yield a different result using the MAESPA vegetation $T_{sfc}$ than if the TUF-3D surface temperature had been used

\begin{equation}\label{eq:qhveg}
 Q_{H,veg} = h_{i}  (T_{sfc,veg}-T_{conv}) 
\end{equation}

where $h_{i}$ is the previously calculated heat transfer coefficient (Wm$^{-2}$K$^{-1}$) and $T_{conv}$ is the converging canyon temperature (K).

\nomenclature{$Q_{H}$}{sensible heat flux (Wm$^{-2}$)} 
\nomenclature{$Q_{H,veg}$}{calculation of vegetation sensible heat flux (Wm$^{-2}$)} 
\nomenclature{$h_{i}$}{heat transfer coefficient (Wm$^{-2}$K$^{-1}$)} 
\nomenclature{$T_{conv}$}{converging canyon temperature (K)} 

For latent energy fluxes ($Q_{E}$), $Q_{E,veg}$ is the value for the grid square calculated in the MAESPA tree calculations, loaded from the MAESPA data for the individual item of vegetation.

\nomenclature{$Q_{E}$}{latent heat flux (Wm$^{-2}$)}
\nomenclature{$Q_{E,veg}$}{calculation of vegetation latent heat flux (Wm$^{-2}$)} 

Finally, ground storage fluxes ($Q_{G}$) of vegetated grid squares are calculated as a residual of $Q^{*}$ - $Q_{H}$ - $Q_{E}$. Calculation of $Q_{G}$ uses Equation (\ref{eq:qgvtuf}) for grid squares containing vegetation (calculating $Q_{G,veg}$), while non-vegetated grid squares calculate $Q_{G,street}$ in Equation (\ref{eq:qgtuf}) to calculate the street ground storage fluxes

\begin{equation}\label{eq:qgvtuf}
 Q_{G,veg} =  Q^{*}_{veg} - Q_{H,veg} - Q_{E,veg}
\end{equation}

\begin{equation}\label{eq:qgtuf}
 Q_{G,street} = k_{1}  ( T_{sfc} - T_{1} ) \frac {2}{T_{m}}
\end{equation}

where $k_{1}$ is the thermal conductivity of the surface (Wm$^{-1}$K$^{-1}$) , $T_{1}$ is the temperature of the shallowest layer (K), and $T_{m}$ is the temperature of the deepest layer (K).

\nomenclature{$Q_{G}$}{ground heat storage (Wm$^{-2}$)}
\nomenclature{$Q_{G,veg}$}{calculation of vegetation ground heat storage (Wm$^{-2}$)} 
\nomenclature{$Q_{G,street}$}{calculation of street ground heat storage (Wm$^{-2}$)} 
\nomenclature{$T_{1}$}{temperature of the shallowest layer (K)} 
\nomenclature{$T_{m}$}{temperature of the deepest layer (K)} 
\nomenclature{$k_{1}$}{thermal conductivity of the surface (Wm$^{-1}$K$^{-1}$)} 

\subsection{Convection}\label{sec:convection}
Convection is implemented as an adaptation of the facet-averaged approach of \cite{Masson2000}. Horizontal advective exchanges are not considered, which is considered to be a reasonable approach given the well-mixed nature of canopy layer air \citep{Krayenhoff2007}. A more accurate but computationally intensive approach could be undertaken using a computational fluid dynamics (CFD) method. However, forcing by the convection between facets is likely less important than the forcing of surface temperatures through the shaded and unshaded radiation distribution and its interactions of surface material properties \citep{Krayenhoff2007}. The following convection sub-modules (of Section \ref{sec:convection}) are completely contained in TUF-3D and full details of calculations are contained in \cite{Krayenhoff2007}.

\subsubsection{Wind speed profile}\label{sec:windspeedprofile}
The wind speed profile within the roughness sub-layer (RSL), a log profile based on \cite{Masson2000}, \cite{Kusaka2001}, and \cite{Harman2004}. An exponential profile is used for the urban canopy, based on \cite{Masson2000} and \cite{Rotach1995}, calculating $U(z)$, the wind speed at height z (m s$^{-1}$).

\nomenclature{$U(z)$}{wind speed at height z (m s$^{-1}$)}  

\subsubsection{Temperature profile and canopy energy budget}\label{sec:tempprof}
The temperature profile treats canyon temperature ($T_{can}$) as constant for $z < z_{H}$, allowing a single canopy-air energy budget. Calculation of $T_{can}$, the canopy air temperature ($z < z_{H}$) (K), uses the energy budget of the air volume below $z = z_{H}$. 

\nomenclature{$T_{can}$}{canopy air temperature ($z < z_{H}$) (K)} 

\subsubsection{Surface convection}

The convective sensible heat flux density (Wm$^{-2}$), $H$, from a horizontal patch $i$ is calculated in Equation (\ref{eq:convh})
\begin{equation} 
H_{i} = h_{i} (T_{sfc,i}-T(z_{horz,i}))
\label{eq:convh} \end{equation} 
where $T_{sfc,i}$ is the surface temperature of patch i (K),
$h$ is the convective heat transfer coefficient (Wm$^{-2}$K$^{-1}$), 
$T(z)$ is the air temperature at height z (K), and 
$z_{horz,i}$ is the height of the patch centre.

%\nomenclature{$h_{i}$}{heat transfer coefficient (Wm$^{-2}$K$^{-1}$)} 
%\nomenclature{$T_{sfc,i}$}{surface temperature of patch i (K)} 
%\nomenclature{$T(z)$}{air temperature at height z (K)} 
%\nomenclature{$z_{horz,i}$}{height of patch forcing U(z) and T(z) above street level of patch i (m)} 

Convection from walls is also calculated using Equation (\ref{eq:convh}) where $h_{i}$ is calculated in Equation (\ref{eq:convw})
\begin{equation} 
h_{i} = r_{w,i}(11.8+4.2 U_{eff}(z_{i}))-4.0
\label{eq:convw} \end{equation} 
where 
$r_{w,i}$ is the wall roughness coefficient of patch i,
$z_{i}$ is the depth to the bottom of layer i (m), and
$U_{eff}(z)$ is the effective wind speed at height z (m s$^{-1}$).

%\nomenclature{$r_{w,i}$}{wall roughness coefficient of patch i} 
%\nomenclature{$z_{i}$}{depth to the bottom of layer i (m)} 
%\nomenclature{$U_{eff}(z)$}{effective wind speed at height z (m s$^{-1}$)} 

\subsection{Water balance}\label{sec:waterbalance}
Water cycle functionality is supplied by MAESPA modules. Each item of vegetation will be individually modelled using a single instance of MAESPA, supported by the built in water balance routines. Soil layers are configurable (set to 10 by default). Complete details of the following calculations (of all modules in Section \ref{sec:waterbalance}) are contained in \cite{Duursma2012}.



\subsubsection{Infiltration}

Infiltration is based on a function from the BROOK90 model \citep{Federer2003} infiltrating rain falling on the soil surface through the soil layers.





\subsubsection{Root water uptake}
Root water uptake calculates $F_{R}$, the cumulative fraction of fine roots to depth z (m). Next, treating the root system as a number of resistances in parallel, $E_{i}$, the root water uptake (canopy transpiration) out of layer i (mm) is calculated. In order to solve the equation simultaneously across multiple soil layers, calculations of $E_{i}$ are simplified using assumptions of \cite{Taylor1975}.

%\nomenclature{$F_{R}$}{cumulative fraction of fine roots to depth z (m)} 
%\nomenclature{$E_{i}$}{root water uptake (canopy transpiration) out of layer i (mm)} 


\subsubsection{Soil evaporation}\label{sec:soilevaporation}

Soil evaporation is only drawn through the top later and assumed to travel through a thin dry layer at the soil surface. It is based on models developed by \cite{Choudhury1988} and \cite{Williams2001}. Calculation of $E_{s}$, the rate of evaporation (mm), is based on the difference between vapour pressure differences in soil pore space and the air above. In the calculation of $G_{ws}$, the conductance of water vapour through the soil pore space (m s$^{-1}$), as the thickness of the layer of dry soil at the surface increases, more resistance to air evaporation is created. Calculation of $D_{eff}$, the effective diffusivity of the soil pore space (m$^{2}$s$^{-1}$), accounts for changes in diffusivity with changing soil temperatures. Finally, $e_{s}$, the partial water vapour pressure of the soil pore space (KPa), is calculated. 

%\nomenclature{$E_{s}$}{rate of evaporation (mm)} 
%\nomenclature{$G_{ws}$}{conductance of water vapour through the soil pore space (m s$^{-1}$)} 
%\nomenclature{$D_{eff}$}{effective diffusivity of the soil pore space (m$^{2}$s$^{-1}$)} 
%\nomenclature{$e_{s}$}{partial water vapour pressure of the soil pore space (KPa)} 



\subsubsection{Canopy interception}
In order to account for canopy interception of precipitation, the \cite{Rutter1975} rainfall interception model is used. In this, rain can either fall through the canopy to the ground or be intercepted by the canopy in a slowly draining canopy pool. For the second option, the canopy pool is filled until reaching a maximum volume, after which any additional rainfall immediately follows the first pathway to the ground. Some amount of water is also evaporated from the canopy. 




\subsubsection{Drainage}

Drainage of soil water is solved downward, layer by layer, in which the change of $W_{i}$, the water storage of the layer i (mm), is calculated based on the soil hydraulic conductivity (m/s) in each layer.

%%\nomenclature{$W_{i}$}{water storage of the layer i (mm)} 


\subsubsection{Hydraulics of the soil-to-leaf pathway}

Hydraulics of the soil-to-leaf pathway, $k_{L}$, the total leaf-specific hydraulic conductance (mmol m$^{-2}$s$^{-1}$MPa$^{-1}$), is calculated using the total hydraulic resistance for all soil layers combined (MPa s m$^{2}$mol$^{-1}$) (estimated using the single root model of \cite{Gardner1960}).

%\nomenclature{$k_{L}$}{total leaf-specific hydraulic conductance (mmol m$^{-2}$s$^{-1}$MPa$^{-1}$)} 





\subsection{Tmrt and UTCI}\label{sec:tmrtutci}

VTUF-3D provides output of downward and upward shortwave and longwave and $T_{sfc}$ for each surface at each time step. Air temperature for the canyon, $T_{can}$ (calculated in Section \ref{sec:tempprof}) is also provided for each timestep. Using these and values of vapour pressure from the forcing data and wind speed at street level (calculated in Section \ref{sec:windspeedprofile}), the values for $T_{mrt}$ and UTCI are calculated for each surface. Options in the model are available to either calculate $L\downarrow$ or use forcing values. Based on this, different options can be used to calculate the following equations.

\subsubsection{Globe temperature calculation}
\nomenclature{$T_{g}$}{globe temperature (K)} 

Calculations of mean radiant temperature $T_{mrt}$ uses a two step procedure. First, globe temperature ($T_{g}$) is solved, using an iterative relaxation solution, using a formulation of \cite{Liljegren2008} in Equation (\ref{eq:tg2}) 


\begin{equation}\label{eq:tg2}
\begin{split}
A\epsilon_{g}\sigma T_{g}^{4} &= \frac{A}{2} \epsilon_{g}\sigma( \epsilon_{a} T_{a}^{4} +  \epsilon_{sfc} T_{sfc}^{4} ) \\
&+ \frac{A}{2}( 1-\alpha_{g})(1-f_{dir})S  \\
&+ \frac{A}{4}( 1-\alpha_{g})f_{dir}S /\cos(\theta) \\
&+ \frac{A}{2}( 1-\alpha_{g})\alpha_{sfc}S \\
&- Ah(T_{g}-T_{a})   
\end{split}
\end{equation}

where $A$, is the surface area of a sphere of diameter D, of value 0.15m, (=$\pi$0.15$^{2}$m$^{2}$),
$\epsilon_{a}$, the longwave emissivity of the atmosphere, 
$\epsilon_{g}$, the globe emissivity (=0.95), 
$h$, the convective heat transfer coefficient (Wm$^{-2}$K$^{-1}$) (see Equation (\ref{eq:h})), 
$\sigma$, the Stefan-Boltzmann constant (=5.67 $\times$ 10$^{-8}$Wm$^{-2}$K$^{-4}$), 
$T_{a}$, the dry bulb air temperature (K) (using $T_{can}$), 
$T_{sfc}$, the surface temperature (K), 
$S$, the horizontal solar irradiance (Wm$^{-2}$) calculated from the total of absorbed and reflected shortwave (resulting from calculations in Section \ref{sec:radiativetransfer}), 
$\theta$, the solar zenith angle, 
$\alpha_{sfc}$, the surface albedo (=0.15),  
$\alpha_{g}$, the globe albedo (=0.05), and 
$f_{dir}$, the fraction of the total horizontal solar irradiance, $S$, due to the direct
beam of the sun. 

\nomenclature{$A$}{surface area of a sphere of diameter D, of value 0.15m, (=$\pi 0.15^{2}$m$^{2}$)} 
\nomenclature{$\epsilon_{a}$}{longwave emissivity of the atmosphere} 
\nomenclature{$\epsilon_{g}$}{globe emissivity (=0.95)}  
\nomenclature{$h$}{convective heat transfer coefficient (Wm$^{-2}$K$^{-1}$)} 
%\nomenclature{$\sigma$}{Stefan-Boltzmann constant (=5.67 $\times$ 10$^{-8}$Wm$^{-2}$K$^{-4}$)} 
\nomenclature{$T_{a}$}{dry bulb air temperature (K)} 
\nomenclature{$S$}{horizontal solar irradiance (Wm$^{-2}$)}  
\nomenclature{$\theta$}{solar zenith angle} 
\nomenclature{$\alpha_{sfc}$}{surface albedo (=0.15)} 
\nomenclature{$\alpha_{g}$}{globe albedo (=0.05)} 
\nomenclature{$f_{dir}$}{fraction of the total horizontal solar irradiance, $S$, due to the direct
beam of the sun}

The convective heat transfer coefficient, $h$, is calculated using Equation (\ref{eq:h})

\begin{equation}\label{eq:h}
Nu = 2.0 + 0.6Re^{1/2}Pr^{1/3};  ~~h = k / D Nu
\end{equation}

where $Nu$ is the Nusselt number (-),
$Re$, the Reynolds number (-),
$Pr$, the Prandtl number (-), and 
$k$, the thermal conductivity of the fluid (i.e. air) (Wm$^{-1}$K$^{-1}$) \citep{Liljegren2008}.

%\nomenclature{$Nu$}{Nusselt number (-)} 
%\nomenclature{$Re$}{Reynolds number (-)} 
%\nomenclature{$Pr$}{Prandtl number (-)} 
\nomenclature{$k$}{thermal conductivity of the fluid (i.e. air) (Wm$^{-1}$ K$^{-1}$)} 

Depending on user defined scenario model configuration settings, a number of terms in Equation (\ref{eq:tg2}) can use internally calculated values. $\sigma(\epsilon_{a} T_{a}^{4} + \epsilon_{sfc} T_{sfc}^{4} )$ will be replaced with $L\downarrow + L\uparrow$, the result of reflections of $L \downarrow_{i,sky}$ calculated in Section \ref{sec:radiativetransfer}). $(1-f_{dir})S$ will be replaced with $K \downarrow_{dif}$ and $f_{dir}S/ \cos(\theta)$ with $K \downarrow_{dir}$. 

\nomenclature{$L \downarrow_{i,sky}$}{initial incident sky-derived longwave (Wm$^{-2}$)} 
\nomenclature{$K\downarrow_{dif}$}{domain-level incoming diffuse shortwave (W m$^{-2}$)}
\nomenclature{$K\downarrow_{dir}$}{domain-level incoming direct shortwave (W m$^{-2}$)}



Also, for vegetated grid squares, the terms for $L\downarrow$ and $L\uparrow$ will be replaced with calculations of $L\downarrow$ and $L\uparrow$ from $\epsilon \sigma T^{4}$ where $T_{s,1}$, soil surface temperature (K), is used as the temperature term for the $L\uparrow$ calculation while leaf temperature (from Section \ref{sec:calcleaftemp}) is used for $L\downarrow$. Otherwise, the following sequence of equations are used to calculate the terms for Equation (\ref{eq:tg2}).

\nomenclature{$\epsilon$}{longwave emissivity}
\nomenclature{$T_{s,1}$}{soil surface temperature (K)}



\subsubsection{$T_{mrt}$ calculation}




Using $T_{g}$, calculated in Equation (\ref{eq:tg2}), the second step in calculating $T_{mrt}$ proceeds in Equation (\ref{eq:tmrtbucket}) of \cite{Kantor2011}
\begin{equation}\label{eq:tmrtbucket}
  T_{mrt} = 
  \bigg(
   (T_{g}+273.15)^{4} + 
    \frac{1.1 \times 10^{8}  ws_{cm}^{0.6}}{\epsilon_{g}  D^{0.4}}
    \times 
     (T_{g}-T_{a})
    \bigg)^{0.25} - 273.15
\end{equation}
 where $ws_{cm}$ is the wind speed (cm s$^{-1}$).

%\nomenclature{$ws_{cm}$}{wind speed (cm s$^{-1}$)} 

\subsubsection{UTCI calculation}
Finally, the UTCI for each surface is calculated, using the \cite{Brode2009u} UTCI formula, in Equation (\ref{eq:utci})

\begin{equation}\label{eq:utci}
  UTCI = f(T_{a}, ws, rh, T_{mrt})
\end{equation}

generating a UTCI value for each surface, using input of $T_{a}$, air temperature (using $T_{can}$), $ws$, wind speed (m s$^{-1}$) (using model calculated $U_{road}$, the wind speed at road level), $rh$, relative humidity (\%) (from forcing data), and $T_{mrt}$. If canopy level $rh$ observed data is available (as opposed to forcing data possibly recorded above the canopy), post processing can recalculate UTCI using these values. VTUF-3D does not currently calculate a canopy level $rh$. This is a current limitation and a future enhancement for the model.

\nomenclature{$ws$}{wind speed (m s$^{-1}$)} 

This UTCI formula was designed to provide human thermal comfort assessments using thermal environment parameters with fixed values (incorporated into the formula) for metabolic rates and clothing levels \citep{Brode2012a}. While future development is needed to provide wider flexibility to vary metabolic rates and clothing levels, existing versions of this formula were developed to embody equivalent human physiological responses to differing thermal parameters \citep{Havenith2012,Fiala2012}.



\subsection{VTUF-3D model integration}\label{sec:integration}
\subsubsection{TUF-3D shading logic}\label{sec:existingshading}
In order to understand the changes made to create VTUF-3D, an overview of the TUF-3D logic is necessary. Two dimensional (x,y) locations of building locations are configured along with their heights. TUF-3D uses forcing data of temperature, humidity, incoming radiation levels, and wind speed and direction from a location at specified z height (above the canopy). Wind is used in roughness calculations but not used to resolve movements around the buildings (as a CFD based model would). This simplification is a design decision trade-off to reduce the complexity of the model and the intensity of computations, while still producing accurate enough results (see Section \ref{sec:convection}).



\begin{figure}[!htbp]
%\fbox{
\includegraphics[trim = 15mm 50mm 132mm 15mm, clip, scale=0.75]{images/ModelDiagramsCombined2.pdf}
%   }
   \caption{(a) Initial view angles ray tracing, run during model initialisation to determine which surfaces are visible to each other. \label{fig:initray} (b) TUF-3D unmodified shading logic in which each surface performs four ray traces (from each surface quarter) towards the sun and determines sunlit percentage based on how many rays leave the domain without meeting an obstruction. Trees do not exist in this version (they will be added in Figure \ref{fig:modshading}e) but are shown to illustrate how their impact is missing from the unmodified logic. \label{fig:shading} (c) VTUF-3D modified shading, timestep ray tracing, using the same process as the unmodified logic but setting a flag for any ray that encounters vegetation. \label{fig:modshading} (d) VTUF-3D modified shading, reverse ray tracing. For any rays that encounter vegetation in forward ray tracing, reverse ray traces are performed to allocate radiation to intervening encountered surfaces. \label{fig:modshadingreverse}} 
\end{figure}

%\nomenclature{$z_{H}$}{mean building height (m)} 

During the model initialisation stage, ray tracing is done (Figure \ref{fig:initray}a) between all surfaces to determine which surfaces are visible to each other. This step reduces the number of radiative interactions of surfaces that will need to be considered throughout the simulation run. As the model runs a simulation, at each time step, TUF-3D runs a shading routine (Figure \ref{fig:shading}b). In it, the model iterates through each surface in the domain (roads and building walls and roofs) and ray-traces towards the sun. Each of these surfaces (patches) are divided into quarters and each of these are ray-traced from the centre of each quarter. 


Each surface keeps track of the level of illumination, the shade coefficient for that surface, at each timestep. If the ray passes to the top of the domain without being obstructed (i.e. surface 4) then 0.25 is added to the shade coefficient for that surface. If the ray is obstructed before reaching the top of the domain (i.e. surface 3), then nothing is added. Each surface has potential values of 0, 0.25, 0.5, 0.75 and 1.0. During the later energy balance step, an appropriate amount of incoming radiation is allocated to this surface based on this coefficient.

\subsubsection{Integrating vegetation shading and modified ray tracing logic in VTUF-3D}\label{sec:Representationofvegetation}

After model improvements to VTUF-3D are made, a similar parallel logic is used to represent the vegetation in the domain. These vegetation elements are ignored in the initialising ray-tracing (Figure \ref{fig:initray}a). As this data is used to determine which surfaces will never be visible to each other, vegetation, depending on its density, may allow some level of transmission and must be considered on a case by case basis during the simulation run.

At each time step during the simulation, VTUF-3D now runs a modified shading routine (Figure \ref{fig:modshading}c). During the model iteration through each surface in the domain, ray-traces towards the sun are done as described previously. However, each step of the ray trace checks to see if vegetation has been encountered. If vegetation is encountered, a vegetation encountered flag is set. Then the ray trace continues and concludes when it either passes out of the domain or is blocked by a building. 

To resolve the sunlit factor for surfaces that encountered vegetation during the ray trace, reverse ray tracing is done for those beams (Figure \ref{fig:modshadingreverse}d). For surfaces 5 and 6, ray tracing is done from the top of the domain back along the radiation path. When the ray encounters vegetation (surfaces 5 and 6), VTUF-3D looks up the tree associated with the ground surface below and loads the offline calculations of the amount of radiation reflected, absorbed, and transmitted through the vegetation (further described in Section \ref{sec:MAETrans}). The ray tracing continues, allocating the remaining radiation either to further intercepting vegetation or ultimately to the ground surface. Through this reverse ray tracing process, the problem of zero to many surface interceptions is solved by allocating radiation as it is transmitted from the sun and transmits through the zero to many objects it encounters along its path. 

\subsubsection{MAESPA vegetation transmission and energy balance functionality overview}\label{sec:MAETrans}

MAESPA, as originally designed, allows modelling of a stand of trees or of a single grid square containing a single tree. VTUF-3D uses this functionality from MAESPA in two different ways. The first is MAESPA's calculations of radiation movement through the vegetation canopy. Each tree in the VTUF-3D modelling domain is individually modelled by MAESPA before the main modelling run and then these data are extracted by VTUF-3D and used throughout the simulation. 


Through these shading modifications, VTUF-3D stores states of and represents vegetation through placeholder simple block structures in VTUF-3D (Figure \ref{fig:TUFWithMaespaVegRadiation}), but calculates the underlying processes using their true shapes and types through the MAESPA representation. Calculated transmission values are used to distribute radiation to the appropriate surfaces during the reverse ray tracing process to determine how much radiation is scattered by the vegetation, radiation absorbed by the vegetation, while the remaining amount of radiation is then distributed to subsequent vegetation, and ultimately to the ground surface at the end of the ray. 

The second integration of MAESPA is used in the surface energy balances. Flux amounts (pre-calculated offline) for each vegetation element for each time step are loaded at the beginning of the simulation and used to repartition the energy fluxes for those surfaces with vegetation on them, using the appropriate values for either sunlit or shaded vegetation. 


\subsubsection{VTUF-3D use of MAESPA differential shading values}\label{sec:4diffshading}

In order to account for intra-tree shading or shading by buildings, each tree in the domain is modelled twice, using varied amounts of incoming shortwave. The proper data variation for each is chosen during the model run. The incoming shortwave is varied in two different ways. The first uses 100\% values. The second reduces incoming shortwave to diffuse values only. Proper forcing data will need to be provided by the user to supply these values. As shortwave radiation levels vary in locations in an urban canyon across the diurnal cycle, use of these differential values captures the differing vegetation responses, such as varying levels of photosynthesis due to lower levels of PAR, changes in surface temperatures, and varying vegetation evapotranspiration due to differences in stomatal conductance and vapour pressure deficits.



\subsubsection{MAESPA configurations creation}\label{section:MaespaTreeConfig}




As all the vegetation parameterisations in VTUF-3D are pluggable, individual elements are added to a domain using a specific set of configuration files with many of the physical properties scaled from a base template.  Including additional vegetation types (trees, shrubs, and ground cover) into VTUF-3D can be added by populating templates with parameter values based on observations or literature values. Currently there are complete parameterisations for two tree species, \textit{Olea europaea} and \textit{Lophostemon Confertus}, as well as turf grass, tall fescue (\textit{Festuca arundinacea}). An example is shown in \ref{sec:maespavegpara}.  


\section{Results}
\subsection{Model evaluation}
Validations of VTUF-3D (Vegetated Temperatures Of Urban Facets) need to be performed to ensure that this new model is making accurate predictions. As an energy balance model, modelled output comparisons to observations of energy fluxes and temperatures are considered fundamental validations \citep{Masson2002a}. With the addition of vegetation modelling, it is important that those aspects are also properly validated. 

The VTUF-3D v1.0 model has been validated using an extensive validation process to ensure that a number of different aspects of the model are functioning properly and is suitable for the task of assessing WSUD impacts on HTC. The validation used three different observational datasets. A validation against flux tower observations \citep{Coutts2007}, is detailed in the next section and VTUF-3D is found to show good performance in partitioning fluxes. In addition, it will be shown that VTUF-3D's performance is above the mean and close to maximum performance of other urban models, as analysied by \cite{Best2012}. 

Two additional validations were performed and will be discussed in a forthcoming paper. In these, a validation showed VTUF-3D's ability to accurately model spatial and temporal patterns of $T_{mrt}$ and $UTCI$ across two differing urban canyons, using observations from George St. and Gipps St. in the City of Melbourne \citep{Coutts2015,White2012}. Finally, a last validation tested VTUF-3D's ability to reproduce the temporal patterns of vegetation physiological responses seen in the observations of street tree transpiration due to urban canyon geometry effects. These observations were based on a  tree study campaign recorded at Smith St. in Melbourne \citep{Gebert2012,Coutts2014a} and it was demonstrated that VTUF-3D was able to successfully capture these patterns.

\subsection{Model validation using Preston flux observations}\label{sec:PrestonValidations}


To validate VTUF-3D's accuracy in partitioning fluxes, a validation was performed based on flux tower observations recorded in Preston. Preston is a homogeneous, medium density suburb in the northern part of Melbourne, Australia. A 40 meter flux tower recorded observations during 2003 and 2004 \citep{Coutts2007}, providing observed values of $Q^{*}$, $Q_{H}$, $Q_{E}$, air temperature, humidity, wind speed and direction. $Q_{G}$ was calculated as a residual value. Estimates of $Q_{F}$ made using an inventory approach, though $Q_{F}$ is included implicitly in the observations and contributes to the observed sensible heat fluxes. 

\nomenclature{$Q_{F}$}{anthropogenic heat (W m$^{-2}$)}

The use of this data set allows validation of surface energy balances against modelled predictions. This data set was also used as the forcing and comparison data set for Phase 2 and 4 of the International Urban Energy Balance Models Comparison Project \citep{Grimmond2011,Best2012}. Phase 2 of this comparison project evaluated the performance of 32 urban land surface modelling schemes, forced by and comparing to these observations, using a consistent methodology. Phase 4 re-evaluated many of these modelling schemes for their performance across a variety of seasonal cycles.

A modelled domain (500x500m with a 5m grid resolution) was chosen to be representative of the overall area observed by flux tower. The measurement height for the observations ensured that the measured fluxes well represented the local scale (10 to 1000 meters) of the area \citep{Coutts2007}. Additionally, the site selection ensured a homogeneous nature of the overall flux coverage area \citep{Schmid1994}. Because of this, the micro-scale modelled domain will be representative of the observed fluxes observed at a local scale. 

%\begin{figure}[!htbp]
%\includegraphics[trim = 0mm 0mm 00mm 0mm, clip, scale=0.80,width=\textwidth]{/home/kerryn/git/Images/PrestonOverall1.png}
%\caption{Preston suburb and modelled area. Adapted from \cite{GooglePreston2015}.\label{fig:PrestonModArea}} 
%\end{figure}

\cite{Coutts2007} provides expert and manual classifications (done at the time of the observations, 2003-2004) from aerial imagery (from 2002) within a 500m radius of the observation tower. The selected modelling area is in good agreement with the 500m classification of \cite{Coutts2007} with respect to the pervious/impervious fractions. An analysis by \cite{Nury2015} of the Darebin Council area (55.6 km$^{2}$) (which includes Preston) using LIDAR data from 2008 is also included because it provides a more recent set of land surface data for the 500m radius area. Breakdowns of both classifications are shown in Table \ref{tab:expertValues}.

\begin{table}[!htbp]
\caption
{Preston land cover breakdowns: using expert and manual classification methods and average of both methods in 500m radius from observation tower \citep{Coutts2007}, Darebin Council land cover fractions \citep{Nury2015}, modelled Preston 5m resolution validation domain land cover fractions (all in percentages). \label{tab:expertValues}} 
  \begin{tabular}{ |c |c| c | c |c |c |c|p{1.65cm}|p{1.65cm}| } 
	\hline \textbf{Source}   & \textbf{Buildings}&	\textbf{Road}&\textbf{Concrete}	&\textbf{Trees}&\textbf{Grass}&\textbf{Water}&\textbf{Total Impervious}&\textbf{Total Vegetation} \\ \hline
 \textbf{Expert}&	44.0&	13.0&	3.0&	29.0&	11.0	&0.0	&	60.0&	40.0 \\ \hline 
 && \multicolumn{2}{|c|}{16.0} 	&&&&&\\ \hline  
 \textbf{Manual}&	45.0	&13.0	&6.0&	16.0&	19.0&	1.0&		64.0&	36.0 \\ \hline
 && \multicolumn{2}{|c|}{19.0} 	&&&&&\\ \hline 
 \textbf{Average} &	44.5&	13.0&	4.5&	22.5&	15.0&	0.5&		62.0&	38.0 \\ \hline
 && \multicolumn{2}{|c|}{17.5} 	&&&&&\\ \hline  
\textbf{\cite{Nury2015}}& 32.0&	20.6&	13.9&	10.1&	23.4&	0&		66.5&	33.5 \\ \hline
 & & \multicolumn{2}{|c|}{34.5} 	&&&&&\\ \hline	
\textbf{Modelled} & 45.2	& \multicolumn{2}{|c|}{19.3} & 16.0	& 19.5 &0& 64.5 &35.5 \\ \hline
  \end{tabular} 
 \end{table}  

Aerial imagery from 2015 \citep{GooglePreston2015} was used as an initial basis for the modelling domain. Some reduction in vegetation cover is seen between the 2004 observation site classification and the 2008 Darebin Council area classification. This introduces a small amount of uncertainly in the exact make-up of the modelling domain and could explain some of the low predictions of $Q_{E}$ seen later in this validation. While this dataset is at a different scale and from a later time period, it does show good agreement with the total impervious/pervious fraction of the 500m classification. Overall, the modelled domain selection is very similar to the broader area, is representative of the local scale and will allow an appropriate comparison between the observed and modelled results. 

%\begin{figure}[!htbp]
%\includegraphics[trim = 0mm 0mm 0mm 0mm, clip, scale=0.30]{/home/kerryn/Documents/Work/PrestonData/Preston-5m_Heights.png}     
%\caption[Digitisation of modelled Preston suburban street]{Digitisation of Preston suburban street, Oakhill Ave. (\textbf{1}=building heights, \textbf{\textcolor{green}{1}}=vegetation heights (in 5m units)). Adapted from \cite{Nearmap2015}.\label{fig:PrestonDigitization} }     
%\end{figure}    



%\begin{figure}[!htbp]a)
%\includegraphics[trim = 0mm 0mm 0mm 0mm, clip, scale=0.20]{/home/kerryn/Documents/Work/VTUF-Runs/PrestonBase/PrestonBase8/CentralBuildingHeights.png} ~b) \includegraphics[trim = 0mm 0mm 0mm 0mm, clip, scale=0.20]{/home/kerryn/Documents/Work/VTUF-Runs/PrestonBase/PrestonBase8/CentralVegHeights.png}
%\caption{a) Preston validation domain configured building heights (0, 5, 10m) and locations.\label{fig:PrestonBldHt} b) Preston validation domain configured vegetation heights (0, 5, 10m) and locations.\label{fig:PrestonVegHt}}      
%\end{figure}




The urban form of this area, the Local Climate Zone (LCZ) \citep{Stewart2012b}, would be characterised as LCZ 6 (open low-rise).  Other properties of the observation site are listed in Table \ref{tab:prvalpara}.

\begin{table}[!htbp]
\caption{Preston validation site properties \citep{Coutts2007}. \label{tab:prvalpara}}     
\begin{tabular}{| l | l |}
\hline
\textbf{Property} & \textbf{Value(s)} \\ \hline
$\alpha$, albedo & 0.15  \\ \hline
$z_{m}$, instrument height (m)&  40  \\ \hline
$z_{0}$, roughness length (m)& 0.4  \\ \hline
$z_{h}$, maximum height of roughness elements (m)& 12  \\ \hline
$z_{b}$, mean building height (m)& 6.4  \\ \hline
$H:W$, mean height to width ratio& 0.42  \\ \hline
$W:P$, mean wall-to-plan ratio &0.4  \\ \hline
\end{tabular}
\end{table}

%The modelled land cover fractions of vegetation consist of 19.5\% grass and 16.0\% trees, matching closely to published land cover classification values for data set. Modelled building densities (Figure \ref{fig:PrestonBldHt}), consisting of 45.2\% buildings and 19.3\% impervious surfaces, also match closely to published land cover classification data set values. All values are summarised in Table \ref{tab:expertValues}.

Model parameters were set to the values given in Table \ref{tab:modprvalpara} and domain parameter values in Table \ref{tab:expertValues}. Most of these values are TUF-3D default values, from \cite{Krayenhoff2007}. Vegetation settings for the two tree types (a 25\%/75\% mix of olive (\textit{Olea europaea}) and brushbox (\textit{Lophostemon Confertus}) trees) as well as grass were set to the values given in the model design vegetation parametrisation section (Section \ref{section:MaespaTreeConfig}). A current limitation of the model is that the available vegetation parametrisations are limited to these three vegetation types. The species mix was chosen to best account for density of canopy cover in the aerial imagery but given this limitation, will not completely reflect the observed species mix and might create some modelling errors from the observed fluxes. However, the two available species are representative of commonly planted trees in Melbourne. A street tree inventory by \cite{Frank2006} finds that brushbox, a native evergreen, is the most common street tree, representing 6.9\% of street trees in Melbourne. Olive trees are considered suitable for Melbourne's climate conditions (drought tolerant evergreen) and a recommended species for council street tree planting \citep{PortPhillip2010}.


\begin{table}[!htbp]
\caption{Preston validation scenario model parameters. \label{tab:modprvalpara}}     
\begin{tabular}{| p{8.0cm} | l | l|}
\hline
\textbf{Parameter} & \textbf{Value(s)} & \textbf{Source}\\ \hline
Albedo (roof, street, wall)   & 0.15, 0.10, 0.30   & \cite{Krayenhoff2007}\\ \hline
Emissivity (roof, street, wall)   & 0.92, 0.92, 0.88   & \cite{Krayenhoff2007}\\ \hline
Forcing data height (m)  & 40   & \cite{Coutts2007} \\ \hline
Mean height of buildings (m)  & 5.61   & Calculated from domain \\ \hline
Mean height of trees (m)  & 5.7   & Calculated from domain \\ \hline
Initial $T_{sfc}$ (roof, street, wall) (\SI{}{\degreeCelsius})  & 18.0, 23.0, 22.0  & \cite{Krayenhoff2007}  \\ \hline
Constant building internal air temperature (base of roofs and walls) (\SI{}{\degreeCelsius})  & 22.0, 20.0 & \cite{Krayenhoff2007}   \\ \hline
Constant deep-ground temperature (\SI{}{\degreeCelsius})  & 19.0  & \cite{Krayenhoff2007} \\ \hline
Constant building internal floor temperature (\SI{}{\degreeCelsius})  & 15.0  & \cite{Krayenhoff2007} \\ \hline
\end{tabular}
\end{table}

The validation simulation (which is named Pr04Val) was run for 30 days between the dates 10 February 2004 and 10 March 2004, forced by the observations, from \cite{Coutts2007} for those days. Values used from the observations include $K\downarrow$, $L\downarrow$, air temperature, wind speed, wind direction, and air pressure. Forcing data for the vegetation components use shortwave values of mean global and mean diffuse observations taken from one minute solar observations (station 086282, Melbourne Airport) \citep{BOM2016}. For full radiation vegetation runs, the Mean\_global\_irradiance\_over\_1\_minute variable from the observations is used. For diffuse runs, the Mean\_diffuse\_irradiance\_over\_1\_minute variable is used. In addition, the MAESPA FBEAM variable (fraction of incident PAR which is direct-beam) is set to 0.0 in the forcing data for diffuse runs.

The validation period contained a range of conditions. The period especially features a number of hot days (over \SI{30}{\degreeCelsius}). As one of the major applications of VTUF-3D will be examining high temperature moderation, validation over a period containing these hot days is important. The observation period also contains a number of days with precipitation. With the current VTUF-3D design, precipitation will only be received in grid squares which contain vegetation and pervious surfaces. The expected impact of this is that predictions of $Q_{E}$ will be understated for days which contain precipitation. Accounting for rainfall on impervious surfaces is a current limitation of VTUF-3D (to be addressed in later versions of VTUF-3D) and caution should be used in modelling periods which contain significant rainfall. In the intended primary use of VTUF-3D, which focuses on temperature moderation in the hottest periods of the year (which contain little rainfall), this should be less of an issue. Also, in most urban areas, precipitation on impervious surfaces will be rapidly removed as stormwater.

%\begin{figure}[!htbp]a)
%{\includegraphics[width=7cm]{/home/kerryn/Documents/Work/Data/PrestonData/PrestonTempFeb2004} }
%~b)
%{\includegraphics[width=7cm]{/home/kerryn/Documents/Work/Data/PrestonData/PrestonPPTFeb2004} }
%    \caption{Preston observations during the validation period of 9 February - 10 March 2004. a) Daily temperature ranges. b) Daily precipitation. \label{fig:Prestontemprain}}    
%\end{figure}





\subsubsection{Preston observations validation scenario}\label{sec:prvalresults}

During this validation, a number of different scenarios (described in Table \ref{tab:simscompared}) are considered and compared. The validation scenario (named Pr04Val) represents the closest approximation of a domain (at a micro-scale) which could be constructed to match the local scaled flux observations. 

\begin{center}
\begin{table}[!htbp]
\caption{Preston simulations and Intercomparison project compared.\label{tab:simscompared}} 
\begin{tabular}{  | p{0.30\linewidth} | p{0.70\linewidth} |  } 
\hline \textbf{Scenario name} & \textbf{Description}  \\ \hline
Pr04NoVeg & Baseline no-vegetation simulation with unimproved TUF-3D    \\ \hline
Pr04Val & Preston 2004 validation scenario  \\ \hline	
IntercomparisonNoVeg & \cite{Best2012} intercomparison performance mean of urban models that do not model vegetation, using \cite{Coutts2007} Preston dataset  \\ \hline
IntercomparisonTiled & \cite{Best2012} intercomparison performance mean of urban models that tile vegetation, using \cite{Coutts2007} Preston dataset  \\ \hline
IntercomparisonIntegrated & \cite{Best2012} intercomparison performance mean of urban models that integrate vegetation, using \cite{Coutts2007} Preston dataset  \\ \hline
  \end{tabular} 
\end{table}
\end{center}  

The first result is given in Figure \ref{fig:Preston6error}. Modelled results for the 30 day run are compared to the observed fluxes ($Q^{*}$, $Q_{H}$, $Q_{G}$, and $Q_{E}$). Error analysis of d index of agreement for the Pr04Val validation (Figure \ref{fig:Preston6error}) shows d values of 0.964, 0.652, 0.998, and 0.957 for $Q_{H}$, $Q_{E}$, $Q^{*}$, and $Q_{G}$ respectively. Error analysis of $RMSE$ (Wm$^{-2}$) shows values of 40.2, 33.1, 19.0,and 52.5. 

\begin{figure}[!htbp]
\includegraphics[trim = 0mm 0mm 0mm 0mm, clip, scale=0.30]{/home/kerryn/Documents/Work/VTUF-Runs/PrestonBase/Analysis/Pr04Val-ErrorPlots.png}
\caption{Pr04Val scenario modelled vs. observations for $Q_{H}$, $Q_{E}$, $Q^{*}$, and $Q_{G}$ fluxes for the period 10 February-10 March 2004. \label{fig:Preston6error}}   
\end{figure}

Individual fluxes ($Q^{*}$, $Q_{H}$, $Q_{G}$, and $Q_{E}$) were aggregated into hourly averages over the 30 days and compared to the observations (Figure \ref{fig:Preston30Day4}). VTUF-3D is able to reproduce the important dynamics of this area, driven by the fluxes. In the observations, the $Q_{H}$ and $Q_{G}$ fluxes dominate the urban area, with modest amounts of $Q_{E}$ fluxes, peaking under 100Wm$^{-2}$ during the daytime and falling to roughly zero at night-time. 

%\begin{figure}[!htbp] 
%\includegraphics[trim = 0mm 0mm 0mm 0mm, clip, scale=0.30]{/home/kerryn/Documents/Work/VTUF-Runs/PrestonBase/Analysis/Pr04Val-EnergyBalanceOverallAve_.png}
%\caption{Pr04Val run 30 day hourly average VTUF-3D flux comparisons to Preston flux observations for the period 10 February-10 March 2004, with error bars at observations standard deviations. \label{fig:Preston30Day}}      
%\end{figure}

\begin{figure}[!htbp] 
\includegraphics[trim = 0mm 0mm 0mm 0mm, clip, scale=0.30]{/home/kerryn/Documents/Work/VTUF-Runs/PrestonBase/Analysis/Pr04Val-EnergyBalanceOverallAve4Plots_.png}
\caption{Pr04Val run 30 day hourly average VTUF-3D flux comparisons to Preston flux observations for the period 10 February-10 March 2004, with error bars at standard deviations. \label{fig:Preston30Day4} }     
\end{figure}



VTUF-3D captures closely both the magnitude and diurnal cycle of $Q_{H}$, with a slight under-prediction during the morning and a slight over-prediction during the late mornings. VTUF-3D also captures closely the cycles of $Q^{*}$. The very small divergence between the predicted and observed values can be explained through the dual sources of values of $K\downarrow$ in the forcing data, a distance of approximately 20 km between Preston and the Melbourne Airport observation site, providing varying values as a component of the calculated $Q^{*}$ which are then compared to only the Preston observations. $Q_{G}$ shows close agreement except for a slight over-prediction during the mornings, an over-prediction at mid-day, a slight over-prediction during the afternoon cooling period, and a very slight over-prediction during the evening.

In terms of absolute values, in 30 day monthly hourly averages, peaking daily values of $Q_{H}$ at 1300 are 314 Wm$^{-2}$ in observed values compared to modelled values of 294. For the other fluxes, $Q_{E}$, $Q^{*}$, and $Q_{G}$, these values are 93 vs. 40, 621 vs. 612, and 213 vs. 266 Wm$^{-2}$.

As an extension to the TUF-3D model, the addition of vegetation and associated $Q_{E}$ fluxes to VTUF-3D have created a large improvement to the model. As will be seen in the Intercomparison results (Section \ref{sec:interresults}), as well as in the results of this intercomparison project \citep{Grimmond2011,Best2012}, land surface modelling schemes that include vegetation perform better than those that do not. 

In addition, schemes that integrate vegetation perform better than those who use a tiling method to include the vegetation. Another important result from this intercomparison project is that $Q_{E}$ is the least well modelled flux across a range of urban land surface modelling schemes \citep{Grimmond2010}. Even the SUEWS model, which includes vegetation, as well as a very complete urban hydrology, tends to under-estimate $Q_{E}$ fluxes during day-time \citep{Jarvi2011}.

It is anticipated that the innovative method taken in this project, the first time vegetation has been tiled and incorporated into a micro-scaled surface energy balance model, will bring performance improvements over the previous model which did not consider vegetation. This will be seen to be the case, shown in the the results of the Pr04NoVeg no vegetation validation scenario (Section \ref{sec:baselinenoveg}). 

In addition to the improved modelling performance, the addition of vegetation modelling has dramatically improved the applicability of VTUF-3D to a wide range of modelling problems. Indeed, without this addition, the main aim of this model, to determine the thermal comfort improvements due to WSUD features would not be possible. 

Despite these improvements to the modelling tool, the fluxes of $Q_{E}$ show some divergences from the observations. This was anticipated as there are three current limitations of VTUF-3D that can account for low $Q_{E}$ levels, and need addressing in future versions of the model. 

The first is not accounting for precipitation on impervious surfaces. Many spikes of $Q_{E}$ fluxes are seen in the observations shortly after rainfall. \cite{Demuzere2014} found evaporation from impervious surfaces in urban areas after rainfall can contribute to an approximately 10\% increase of $Q_{E}$ over a two month period, while \cite{Wouters2013} found increases of 45 Wm$^{-2}$ in $Q_{E}$ for up to 12 hours of daylight following rainfall. Until this portion of precipitation received is accounted for in the model, care should be taken when modelling periods which contain precipitation.

%\begin{figure}[!htbp] 
%\includegraphics[trim = 0mm 0mm 0mm 0mm, clip, scale=0.30]{/home/kerryn/Documents/Work/VTUF-Runs/PrestonBase/Analysis/Pr04Val-QeTimeseries.png}
%\caption{Pr04Val modelled $Q_{E}$ vs. Preston $Q_{E}$ observations including observation of daily high/low temperatures and hourly rain totals for the period 10 February-10 March 2004. \label{fig:Preston30DayQe} }     
%\end{figure}

The second limitation is not accounting for irrigation. While Melbourne was under Stage 2 water restrictions during the observation/modelling period \citep{MelbourneWater2016a}, there would have been some amount of irrigation occurring to contribute to greater observed $Q_{E}$ fluxes than modelled. Estimates of household irrigation during February 2004 are of frequencies of 2.8 times a week (3.1 for only the homes which irrigate) with average irrigation flows of 16.3 LpM and average durations of 46 minutes per irrigation event \citep{Roberts2005}. This is an important limitation which needs addressing as quantifying the benefits of irrigation as part of WSUD is an intended use of this model.

The third limitation is the full diversity of vegetation and trees of the modelled area are not represented in the modelled domain. Current parametrisations only include grass, brushbox, and olive trees. However, this is not a limitation in the model itself, as any type of vegetation can be plugged into the model. To overcome this deficit, more work needs to be done. Completion of each parametrisation is a time consuming process requiring numerous observations of tree physiology specifications. A standard limitation of many empirical models requiring a choice of either deciduous or evergreen vegetation does not exist in the model itself as these new vegetation types can include either, as long as the proper observations and parametrisations are completed on each type.


Finally, values of $Q_{F}$, anthropogenic heat (Wm$^{-2}$), are not accounted for in the VTUF-3D model, but which do contribute to the total $Q_{H}$ fluxes in the observations. Flux values for this modelling and observation period (summertime) are anticipated to contribute peaks of over 15 Wm$^{-2}$ for low density cities and peaks of 30-60 Wm$^{-2}$ for medium density areas \citep{Sailor2004}. In both the observations and modelling results, these unaccounted fluxes will be present in the errors for the four observed and modelled fluxes.

There will remain an amount of uncertainty in comparing the modelled results to the observations because of the nature of both. The observations were collected via a flux tower at 40m height, above the height of the urban roughness sublayer. The modelled results are the average of the fluxes from all of the urban surfaces, within the urban canyon and well within the urban roughness sublayer. While these comparisons can be done, i.e. \cite{Grimmond2011}, there remains an amount of uncertainly as they are comparing two slightly different things. 

A final consideration is that the under-prediction of $Q_{E}$ is likely contributing to the over-estimating of $Q_{G}$ (calculated as a residual in MAESPA vegetation tiles). An improvement in modelling of the $Q_{E}$ fluxes will likely lead to an improvement in the modelled $Q_{G}$ fluxes. 

\subsubsection{No vegetation baseline scenario}\label{sec:baselinenoveg}

To demonstrate the significant improvement of the model, the VTUF-3D model was run with a no vegetation scenario. This scenario (named Pr04NoVeg), will represent an unimproved TUF-3D without vegetation modelling capability, as the lack of vegetation will not trigger any of the new logic and improvements added to the model. This will allow an analysis of level of improvement of VTUF-3D modelling over the previous TUF-3D model. As discussed earlier in this section, the Intercomparison project found that models without vegetation were among the poorest performers.
 
These values show an improvement over the unimproved VTUF-3D model (Pr04NoVeg, shown in Figure \ref{fig:Prestonnovegerror} ). The unimproved model yields results of d of 0.906, 0.0, 0.989, and 0.877 and $RMSE$ (Wm$^{-2}$) of 87.0, 47.1, 51.6, 75.9 for $Q_{H}$, $Q_{E}$, $Q^{*}$, and $Q_{G}$ respectively. As an unimproved model, $Q_{H}$ is significantly over-predicted during the afternoon and under-predicted in the evenings. Flux $Q_{G}$ is under-predicted during the afternoons. Finally, $Q_{E}$ is not implemented in the model, so cannot be predicted at all.


%To complete the comparison with the unimproved TUF-3D model, fluxes for this same period for scenario Pr04NoVeg are shown (Figure \ref{fig:Prestonnoveg30day}). 


\begin{figure}[!htbp]
\includegraphics[trim = 0mm 0mm 0mm 0mm, clip, scale=0.30]{/home/kerryn/Documents/Work/VTUF-Runs/PrestonBase/Analysis/Pr04NoVeg-ErrorPlots.png}
\caption{Pr04NoVeg scenario modelled vs. observations for $Q_{H}$, $Q_{E}$, $Q^{*}$, and $Q_{G}$ fluxes for the period 10 February-10 March 2004. \label{fig:Prestonnovegerror}}    
\end{figure}

%\begin{figure}[!htbp]
%\includegraphics[trim = 0mm 0mm 0mm 0mm, clip, scale=0.30]{/home/kerryn/Documents/Work/VTUF-Runs/PrestonBase/Analysis/Pr04NoVeg-EnergyBalanceOverallAve_.png}
%\caption{Pr04NoVeg run 30 day hourly average VTUF-3D flux comparisons to Preston flux observations for the period 10 February-10 March 2004, with error bars at observations standard deviations. \label{fig:Prestonnoveg30day}}    
%\end{figure}


\subsubsection{Preston validation intercomparison results and discussion}\label{sec:interresults}
During this validation, a number of different scenarios are considered and compared. The Pr04Val scenario (a scenario to best represent the area observed by the Preston flux tower observations) is compared to a baseline Pr04NoVeg scenario (an unimproved TUF-3D without vegetation modelling capability). As the observations used in this validation are the same as in Phase 4 of the Intercomparison project \citep{Best2012}, using the \cite{Coutts2007} Preston dataset, the performance of the VTUF-3D model can also be placed within this evaluation of urban land surface modelling schemes. 

Intercomparison Phase 4 error analysis provides $RMSE$ values for fluxes $Q^{*}$, $Q_{H}$, $Q_{G}$, and $Q_{E}$ for three classifications of urban models. These three categories are of models that do not consider vegetation, those that model vegetation using tiles, and models that integrate vegetation into the urban area (referred to as classifications IntercomparisonNoVeg, IntercomparisonTiled, and IntercomparisonIntegrated, described in Table \ref{tab:simscompared}). These values are taken from Figure 2 of \cite{Best2012}, for the Feb/Mar period, corresponding to the period for which the validation scenarios were run. 

%\begin{figure}[!htbp]
%\includegraphics[trim = 0mm 18mm 00mm 0mm, clip, scale=0.80]{/home/kerryn/git/Images/Best2012-Fig2-IntercomparionsRMSE.png} \caption{Median of the mean modelled flux, MBE, and RMSE for the surface fluxes determined for two month periods, for the models classified by their representation of vegetation. Note the scales are different for each flux \citep{Best2012}. \label{fig:best2012RMSE}}  
%\end{figure}

%\begin{figure}[!htbp] 
%\includegraphics[trim = 0mm 0mm 0mm 0mm, clip, scale=0.25]{/home/kerryn/Documents/Work/VTUF-Runs/PrestonBase/Analysis/IntercomparisonIntegrated-ErrorPlotsRMSECombined2.png}
%\caption{RMSE VTUF-3D vs. Intercomparison results comparison for Preston validations scenarios for 10 February-10 March 2004.\label{fig:prestonrmse}}      
%\end{figure}

\begin{center}
\begin{table}[!htbp]
\caption{RMSE VTUF-3D vs. Intercomparison results comparison for Preston validations scenarios for 10 February-10 March 2004.\label{fig:prestonrmse}} 
\begin{tabular}{  | l | l | l|l|l| } 
\hline \textbf{Scenario name} &\textbf{$Q^{*}$}& \textbf{$Q_{H}$}& \textbf{$Q_{G}$}& \textbf{$Q_{E}$}  \\ \hline
Pr04NoVeg & 19.0&	40.2&	52.5&	33.1    \\ \hline
Pr04Val & 51.6&	87.0&	75.9&	47.1  \\ \hline	
IntercomparisonNoVeg & 40&	105&	85&	38   \\ \hline
IntercomparisonTiled &  27&	60&	77&	25  \\ \hline
IntercomparisonIntegrated & 25&	45&	77&	26   \\ \hline
  \end{tabular} 
\end{table}
\end{center} 

A comparison of Intercomparison RMSE results vs. modelled results is shown in Table \ref{fig:prestonrmse}. In Phase 4 comparisons, for all fluxes, models with integrated vegetation had the lowest $RMSE$ values. These were followed by tiled vegetation models while models without vegetation had the highest values. In comparison, the VTUF-3D Pr04Val scenario had lower $RMSE$ values for all fluxes except $Q_{E}$ than each of the Phase 4 three model categories. For $Q_{E}$, the VTUF-3D scenario Pr04Val performed better than the no vegetation category, but with slightly higher errors than the tiled and integrated categories. In terms of absolute differences between $RMSE$ values for the best performing Intercomparison model category, Pr04Val scenario $RMSE$ values differed by -6, -5, -25, and 7 Wm$^{-2}$ for $Q^{*}$, $Q_{H}$, $Q_{G}$, and $Q_{E}$ respectively.

\subsubsection{Preston validation conclusions}

This analysis of VTUF-3D performance when comparing predicted results to flux tower observations and in comparison to error rates of other urban models has shown significant improvement over the unimproved (non-vegetated) TUF-3D model. Furthermore, these comparisons to observations show the model is able to capture well the temporal and amplitude variations of fluxes observed by flux towers. 

In a comparison of VTUF-3D modelled results to other urban models, VTUF-3D performs well within the range of those other models, even though most of those models are local scaled and not being run at a micro-climate scale. Error analysis puts VTUF-3D's performance in all fluxes except $Q^{*}$ slightly better than the all categories of these models. With the $Q^{*}$ flux, VTUF-3D performs with lower errors than the models in the no vegetation category but with slightly higher errors than in the tiled and integrated categories. 

This validation demonstrates that VTUF-3D performs well in terms of surface energy balances, lending weight to its suitability to assess the impacts of urban greenery on human thermal comfort. Two following validations (to be detailed in a forthcoming paper), will add additional confidence to VTUF-3D's suitability to accurately model urban areas and urban vegetation.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%













\section{Conclusions} \label{sec:DesignConc} 

These modifications to TUF-3D have created a new model, VTUF-3D, able to model vegetation, account for latent energy fluxes, and shown suitable to model WSUD features and their HTC impacts. Two major modifications were made to create VTUF-3D. The first added physical representations of vegetation and allow the shading effects of these features to be modelled. The second added the ability to model vegetation physiological processes (and associated water cycles). These modifications allow surface energy balances to be repartitioned, accounting for latent energy fluxes, as well as the effects that vegetation shading will have on these energy balances. 

A templated scalable configuration system, used to represent arbitrary types of vegetation (or other WSUD features), allows any variety and mix of vegetation to be added to a modelled domain. Also, differential shading functionality allows impacts of urban geometry and inner tree shading on vegetation anywhere in an urban canyon to be properly modelled. Finally, the addition of mean radiant temperature and UTCI output for all surfaces allows detailed analysis of the vegetations impact on these important parameters on HTC in these areas.

An extensive validation process has shown that VTUF-3D is able to accurately model urban areas (including urban vegetation). Now, with the completion and validation of the VTUF-3D v1.0 model, there is a suitable tool to model and study in detail the impacts of urban greening on HTC and recommendations and guidelines on how to best use urban greenery can be developed. Questions can be answered as to the optimal arrangement of canopy cover to give the maximum benefits. Performance of future scenarios can also help inform responses to future challenges, both in terms of urban redesign and planning for emergency responses.

With the VTUF-3D's micro-climate resolution, urban areas can be studied metre by metre and proper mitigation strategies designed for every section of the urban canyon, allowing effort to be focused on areas with the greatest need.  It is sufficiently scaled to resolve human level interactions with their surroundings and provide variables to calculate HTC (such as $T_{mrt}$). The built in output of $T_{mrt}$ and UTCI allows examination of these values without requiring addition steps. Finally, with the ability to insert any type of vegetation (or WSUD feature) using physiological and physical vegetation templates, VTUF-3D is applicable to an unlimited number of scenarios and modelling questions. This new model will allow research into a wide variety of urban morphologies, quantifying the benefits of a wide variety of urban arrangements and allow planning for future changes and challenges in climate and urban design.



\section{Code availability}\label{sec:available}

Development of VTUF-3D was conducted in FORTRAN 2003 \citep{GNU2016a} in Netbeans 8.0.2 \citep{Netbeans2016} and compiled with gfortran 4.8.4 \citep{GNU2016} on Ubuntu 14.04, however, the code should compile on any platform with FORTRAN 2003 support. The original source code for TUF-3D was obtained from the author \citep{Krayenhoff2007}, while source code for MAESPA was obtained from the MAESPA repository \citep{Duursma2016}. The development process merged these code bases and added the additional functionality described in this paper. The VTUF-3D source code is available at \cite{Nice2016c}.

Model configuration process was developed in Java using the JRE 1.7.0 \citep{Oracle2016} in Eclipse 4.5.2 \citep{Eclipse2016}. Data analysis and graphing scripts were generated in R \citep{R2013} and Python \citep{Python2016} using the Matplotlib library \citep{Hunter2007}. 


%% The Appendices part is started with the command \appendix;
%% appendix sections are then done as normal sections
\appendix


%\subsection{}                               %% Appendix A1, A2, etc.


%%%%%%%%%% taking out parameterizations
\section{MAESPA vegetation parameterisations}\label{sec:maespavegpara}  
%
%The physiological properties of the two selected trees and grass were integrated into the configuration files. All parameterisations used in this study share some common attributes, summarised in Table \ref{tab:commonattr}.
%
%\begin{table}[!htbp]
%\caption{MAESPA tree parameterisations common attributes. \label{tab:commonattr}} 
%\begin{tabular}{ |  p{13cm} | p{4cm} |}
%\hline \textbf{Parameter} & \textbf{Value}  \\ 
%\hline
%Stomatal conductance model & Ball-Berry-Opti model \citep{Medlyn2011} \\ \hline
%Number of layers in the crown assumed when calculating radiation interception &6	 \\ \hline
%Number of points per layer&12 \\ \hline
%Number of zenith angles for which diffuse transmittances are to be integrated &5   \\ \hline
%Number of azimuth angles for which diffuse transmittances are to be integrated&11  \\ \hline
%\end{tabular} 
%\end{table}
%
\subsubsection{MAESPA olive tree (\textit{Olea europaea}) parameterisation}
The first complete parameterisation for VTUF-3D is the olive tree (\textit{Olea europaea}). It has been selected because it is a species commonly found in gardens in Melbourne, considered suitable for Melbourne's climate conditions (drought tolerant evergreen), and a recommended species for council street tree planting \citep{PortPhillip2010}. In addition, observations of parameters are available from \cite{Coutts2014a}. The physical and meteorological parameters for a 5x5 meter grid square are given in Table \ref{tab:olivescaled}. 

\begin{center}
\begin{table}[!htbp]
\caption{MAESPA olive tree (\textit{Olea europaea}) parameterisation, tree dimensions for an example 5x5m grid (to be rescaled for taller/shorter modelled trees).\label{tab:olivescaled}}
\begin{tabular}{ |  l | l | l | l |}
\hline \textbf{Parameter} & \textbf{Value} & \textbf{Source} \\ 
\hline
crown radius (m) & 2.5 & \cite{Coutts2014a}\\ \hline
crown height (m) & 3.75 & \cite{Coutts2014a}\\ \hline
trunk height (m) & 1.25 & \cite{Coutts2014a}\\ \hline
leaf area index (m$^{2}$ m$^{-2}$)&2.48 &\cite{Mariscal2000}\\ \hline
crown shape & round &\\ \hline
$z_{Ht}$ (m)&4.0&Forcing data height \\ \hline
$z_{PD}$ (m) &2.5& 2/3 of crown height `rule of thumb' \citep{Grimmond1999}\\ \hline
$z_{0,Ht}$ (m) &0.375& 1/10 of crown height `rule of thumb' \citep{Grimmond1999} \\ \hline
\end{tabular} 
\end{table}
\end{center}

\input{MaespaOliveTreeParametersTable}
%
%The configuration scripts will re-scale these parameters for a given modelling domain grid size. The $z_{Ht}$ value, measurement height of wind speed (m), is taken from the measurement height of forcing data. The $z_{PD}$ value, zero-plane displacement height (m), uses a `rule of thumb' and is calculated as 2/3 of the tree crown height.  The $z_{0,Ht}$ value, roughness length (m), uses a `rule of thumb' and is calculated as 1/10 of the tree crown height.
%
%The specific physiological parameters for this species are given in Table \ref{tab:oliveparam} and are used to generate the appropriate $trees.dat$, $str.dat$ and $phy.dat$ for each olive tree in the domain.  Parameter values were taken from the \cite{Coutts2014a} observations and supplemented with values from the literature.
%
%
%\subsubsection{MAESPA brushbox tree (\textit{Lophostemon Confertus}) parameterisation}
%The second complete parameterisation for VTUF-3D is the  brushbox tree (\textit{Lophostemon Confertus}). This tree is chosen because it is the most common street tree in Melbourne \citep{Frank2006}, where all of the validation observations data sets are based. This tree has also been the basis of a number of research projects in Melbourne, providing a parameterisation through \cite{Coutts2016} and \cite{Coutts2015ICUC}.
%
%
%The physical and meteorological parameters for a 5x5 meter grid square are given in Table \ref{tab:brushscaled}. The configuration scripts will re-scale these parameters for a given modelling domain grid size. The specific physiological parameters for this species are given in Table \ref{tab:brushparam} and are used to generate the appropriate $trees.dat$, $str.dat$ and $phy.dat$ for each brushbox tree in the domain.
%
%\begin{center}
%\begin{table}[!htbp]
%\caption{MAESPA brushbox tree (\textit{Lophostemon Confertus}) parameterisation, tree dimensions for an example 5x5m grid (to be rescaled for taller/shorter modelled trees).\label{tab:brushscaled}} 
%\begin{tabular}{ |  l | l | l |}
%\hline \textbf{Parameter} & \textbf{Value}& \textbf{Source}   \\ 
%\hline
% crown radius (m) & 2.5 &\cite{Coutts2016}\\ \hline
%   crown height (m) & 3.75&\cite{Coutts2016} \\ \hline
% trunk height (m) & 1.25&\cite{Coutts2016} \\ \hline
%  leaf area index (m$^{2}$ m$^{-2}$)&2.0&\cite{Wright2000} \\ \hline
% crown shape & round &\\ \hline
%$z_{Ht}$ (m)&4.0&Forcing data height \\ \hline
%$z_{PD}$ (m) &2.5 & 2/3 of crown height `rule of thumb' \citep{Grimmond1999}\\ \hline
%$z_{0,Ht}$ (m) &0.375 & 1/10 of crown height `rule of thumb' \citep{Grimmond1999}\\ \hline
%\end{tabular} 
%\end{table}
%\end{center}
%
%\input{MaespaBrushboxTreeParametersTable}
%
%\subsubsection{MAESPA grass parameterisation}
%The third complete parameterisation for VTUF-3D is for grass, tall fescue (\textit{Festuca arundinacea}), a common turf grass. This is an important parameterisation for modelling urban environments as a significant portion of urban surfaces are grass. As will be seen in the VTUF-3D validation (forthcoming paper), estimates of observed grass cover, for example in a validation based on observations from Preston in Melbourne \citep{Coutts2007,Nury2015}, range from 11\% to 23\%. 
%
%This parameterisation is an adaptation of the normal MAESPA tree parameterisations. In it, the vegetation is modelled as a box shaped canopy with a crown height of 0.2 meters. This and the rest of the physical and meteorological parameters for a 5x5 meter grid square are given in Table \ref{tab:grassscaled}, with parameter values taken from the literature.
%
%\begin{center}
%\begin{table}[!htbp]
%\caption{MAESPA grass, tall fescue (\textit{Festuca arundinacea}), layer as a box tree on the ground covering the plot area. \label{tab:grassscaled}}
%%\scalebox{0.9}{
%\begin{tabular}{ |  l | l | l |}
%\hline \textbf{Parameter} & \textbf{Value} & \textbf{Source} \\  \hline
%crown radius (m) & 2.5& Radius of 5x5m grid \\ \hline
%crown height (m) & 0.2& \cite{Simmons2011} \\ \hline
%trunk height (m) & 0.01& \\ \hline
%stem diameter (m) & 0.2 &\\ \hline
%leaf area index (m$^{2}$ m$^{-2}$)& 7.13 & ave. from \cite{Bijoor2014} \\ \hline
%crown shape & box& \\ \hline
%$z_{Ht}$ (m)&4.0&Forcing data height \\ \hline
%$z_{PD}$ (m) &0.066 & 2/3 of crown height `rule of thumb' \citep{Grimmond1999}\\ \hline
%$z_{0,Ht}$ (m) & 0.02 & 1/10 of crown height `rule of thumb' \citep{Grimmond1999}\\ \hline
%\end{tabular} 
%%}
%\end{table}
%\end{center}
%
%\input{MaespaGrassParametersTable}
%
%
%%%%%%%%%%end taking out parameterizations





%\section{Symbol list}\label{sec:symbollist}    %% Appendix B




%\authorcontribution{This work was developed by Kerry Nice and supervised by Andrew Coutts and Nigel Tapper. Model source code was received from Scott Krayenhoff and Remko Duursma (as acknowledged in Section \ref{sec:available}). Synthesis of this code and new code was developed by Kerry Nice. The article was written by Kerry Nice with editing and suggestions from Andrew Coutts and Nigel Tapper.}
%
%\begin{acknowledgements}
%The work described in this paper was developed during a PhD. project at Monash University. Funding for this was obtailed through the City of Melbourne, Monash University, and the CRC for Water Sensitive Cities.  
%\end{acknowledgements}

%% \section{}
%% \label{}

%% If you have bibdatabase file and want bibtex to generate the
%% bibitems, please use
%%
  \bibliographystyle{elsarticle-harv} 
  \bibliography{library}

%% else use the following coding to input the bibitems directly in the
%% TeX file.

\begin{thebibliography}{00}

%% \bibitem[Author(year)]{label}
%% Text of bibliographic item

\bibitem[ ()]{}

\end{thebibliography}
\end{document}

\endinput
%%
%% End of file `elsarticle-template-harv.tex'.
